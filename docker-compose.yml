version: '3.9'

services:
  # ============================================================
  # C API Core — puerto 8080
  # ============================================================
  yuzu-api:
    build:
      context: ./c
      dockerfile: Dockerfile
    container_name: yuzu-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    networks:
      - yuzu-net
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    labels:
      - "yuzu.service=api"
      - "yuzu.layer=core"

  # ============================================================
  # C++ Dashboard Web — puerto 3000
  # ============================================================
  yuzu-dashboard:
    build:
      context: ./cpp
      dockerfile: Dockerfile
    container_name: yuzu-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      yuzu-api:
        condition: service_healthy
    networks:
      - yuzu-net
    environment:
      - YUZU_API_HOST=yuzu-api
      - YUZU_API_PORT=8080
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
    labels:
      - "yuzu.service=dashboard"
      - "yuzu.layer=web"

  # ============================================================
  # COBOL Metrics Processor — cron cada 5s
  # ============================================================
  yuzu-metrics:
    build:
      context: ./cobol
      dockerfile: Dockerfile
    container_name: yuzu-metrics
    restart: unless-stopped
    depends_on:
      yuzu-api:
        condition: service_healthy
    networks:
      - yuzu-net
    environment:
      - YUZU_API_HOST=yuzu-api
      - YUZU_API_PORT=8080
    labels:
      - "yuzu.service=metrics"
      - "yuzu.layer=cobol"

  # ============================================================
  # Nginx reverse proxy — puerto 80
  # ============================================================
  yuzu-proxy:
    image: nginx:alpine
    container_name: yuzu-proxy
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - yuzu-api
      - yuzu-dashboard
    networks:
      - yuzu-net
    labels:
      - "yuzu.service=proxy"
      - "yuzu.layer=ingress"

networks:
  yuzu-net:
    driver: bridge
    name: yuzu-network
